name: Deploy to Elastic Beanstalk

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y zip
          python3 -m pip install --upgrade --user awscli
          echo "${HOME}/.local/bin" >> $GITHUB_PATH

      - name: Setup Node.js and build
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies and build
        run: |
          npm ci
          npm run build

      - name: Prune devDependencies for production artifact
        run: |
          # Remove devDependencies so the packaged node_modules contains only production deps
          npm prune --production || true
          du -sh node_modules || true

          # Ensure Next.js server compatibility: some Next builds put server files under
          # `dist/server` while the CLI expects `server/require-hook`. Add a small shim
          # so `require('../server/require-hook')` resolves at runtime on the instance.
          if [ -d node_modules/next ] && [ ! -f node_modules/next/server/require-hook.js ]; then
            mkdir -p node_modules/next/server
            printf "module.exports = require('../dist/server/require-hook');\n" > node_modules/next/server/require-hook.js
          fi

      - name: Zip application
        run: |
          # Ensure platform hooks are executable, exclude large/sensitive files
          chmod +x .platform/hooks/prebuild/enable-swap.sh || true
          zip -r app.zip . -x public/uploads/**\* .git/**\* .env/**\* server.log



      - name: Upload artifact to S3
        env:
          EB_BUCKET: ${{ secrets.EB_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          aws s3 cp app.zip s3://$EB_BUCKET/github-${{ github.run_id }}-app.zip --region $AWS_REGION

      - name: Create Beanstalk application version
        env:
          EB_APP_NAME: ${{ secrets.EB_APP_NAME }}
          EB_BUCKET: ${{ secrets.EB_BUCKET }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          aws elasticbeanstalk create-application-version \
            --application-name "$EB_APP_NAME" \
            --version-label "github-${{ github.run_id }}" \
            --source-bundle S3Bucket="$EB_BUCKET",S3Key="github-${{ github.run_id }}-app.zip" \
            --region "$AWS_REGION"

      - name: Update Beanstalk environment
        env:
          EB_ENV_NAME: ${{ secrets.EB_ENV_NAME }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          aws elasticbeanstalk update-environment --environment-name "$EB_ENV_NAME" --version-label "github-${{ github.run_id }}" --region "$AWS_REGION"
