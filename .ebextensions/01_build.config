container_commands:
  01_set_npm_prod_false:
    command: "export NPM_CONFIG_PRODUCTION=false"
  02_install_and_build:
    command: |
      if [ -d /var/app/staging ]; then
        cd /var/app/staging || exit 1
      else
        cd /var/app/current || exit 1
      fi

      # Try reproducible install including dev deps (npm v9+). Fallback if unsupported.
      if npm ci --include=dev --no-audit --progress=false; then
        echo "npm ci --include=dev succeeded"
      else
        echo "npm ci --include=dev failed, trying npm ci --no-production"
        npm ci --no-production --no-audit --progress=false
      fi

      # Run production build (expects "build" script in package.json)
      npm run build
